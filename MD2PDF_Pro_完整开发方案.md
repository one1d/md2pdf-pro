# MD2PDF Pro - 完整项目开发方案

> 基于SPEC方法论（Specification-Execution-Performance-Completion）  
> 版本: 1.0.0  
> 日期: 2026-02-28  
> 预估工时: 72小时（9个工作日）

---

## 目录

1. [执行摘要](#一执行摘要)
2. [SPECIFICATION - 规范分析](#二specification---规范分析)
3. [EXECUTION - 执行路线图](#三execution---执行路线图)
4. [PERFORMANCE - 性能策略](#四performance---性能策略)
5. [COMPLETION - 完成标准](#五completion---完成标准)
6. [风险与缓解](#六风险与缓解)
7. [交付物清单](#七交付物清单)
8. [附录](#八附录)

---

## 一、执行摘要

### 1.1 项目概览

| 项目属性 | 详情 |
|---------|------|
| 项目名称 | MD2PDF Pro |
| 项目类型 | 批量Markdown转PDF转换器 |
| 技术栈 | Python + Pandoc + Tectonic + Mermaid-CLI |
| 目标平台 | macOS (兼容Linux/Windows) |
| 团队规模 | 1名全栈开发 |
| 预估总工时 | 72工时（9个工作日） |
| 关键路径 | 52工时（6.5个工作日） |

### 1.2 总体评估

| 评估维度 | 评分 | 状态 |
|---------|------|------|
| 功能需求完整性 | 75/100 | ⚠️ 需改进 |
| 技术架构合理性 | 80/100 | ✅ 良好 |
| 规范清晰度 | 65/100 | ⚠️ 需改进 |
| 风险可控性 | 60/100 | ⚠️ 存在风险 |

### 1.3 核心目标

- **功能目标**: 实现批量Markdown转PDF，支持LaTeX公式、Mermaid图表、代码高亮、中文排版
- **性能目标**: 100文件批量转换 < 120秒，内存峰值 < 4GB，成功率 > 98%
- **质量目标**: 单元测试覆盖率 ≥ 85%，代码质量门禁100%通过

---

## 二、SPECIFICATION - 规范分析

### 2.1 功能需求矩阵

| 功能模块 | 技术要求 | 实现方案 | 优先级 | 完整度 | 状态 |
|---------|---------|---------|--------|--------|------|
| **基础转换** | Markdown → PDF | Pandoc + LaTeX | P0 | 90% | 已定义 |
| **数学公式** | LaTeX渲染 (`$...$`, `$$...$$`) | mathspec + amsmath | P0 | 85% | 已定义 |
| **流程图** | Mermaid flowchart/sequence/gantt | mmdc (PDF输出) | P0 | 80% | 已定义 |
| **思维导图** | Mermaid mindmap v9.2+ | mmdc + PDF矢量图 | P0 | 70% | 需补充降级策略 |
| **代码高亮** | 语法着色、行号 | skylighting (pandoc内置) | P0 | 85% | 已定义 |
| **图片处理** | 本地/Web图片、SVG转PDF | aiohttp + rsvg-convert | P1 | 60% | SVG转PDF细节缺失 |
| **并行处理** | 并发>8文件，CPU>80% | asyncio + semaphore | P0 | 65% | 并发策略不明确 |
| **中文支持** | CJK字体、竖排支持 | xeCJK + 系统字体 | P1 | 55% | 字体回退策略缺失 |

### 2.2 技术架构

```yaml
系统架构:
  输入层:
    - 文件扫描: glob pattern匹配
    - YAML Front Matter解析
    - 元数据注入
  
  预处理层:
    - Mermaid渲染器: 代码块→PDF矢量图
    - 图片下载器: 异步HTTP获取
    - 链接检查器: 验证本地资源
  
  转换层:
    - Pandoc引擎池: 多进程隔离
    - LaTeX编译: Tectonic引擎
    - 模板系统: eisvogel/custom
  
  输出层:
    - PDF优化: 压缩/书签
    - 错误报告: JSON格式日志
    - 通知系统: macOS Notification Center
```

### 2.3 架构分层评估

| 层次 | 评分 | 状态 | 主要问题 |
|-----|------|------|---------|
| 输入层 | 75% | 良好 | 未说明符号链接处理 |
| 预处理层 | 85% | 优秀 | 未说明超时处理 |
| 转换层 | 70% | 需改进 | 池大小动态调整未说明 |
| 输出层 | 60% | 需改进 | 优化策略未具体化 |

### 2.4 需求模糊点识别

#### 模糊点 #1: 并行处理参数
- **原文**: "并发>8文件，CPU>80%"
- **问题**:
  - 是"或"关系还是"与"关系？
  - CPU阈值是触发条件还是限制条件？
  - 超过阈值后的降级策略是什么？
- **建议**: 明确定义并发控制算法和阈值处理逻辑

#### 模糊点 #2: Mermaid版本兼容性
- **原文**: "Mermaid mindmap v9.2+"
- **问题**:
  - 低于v9.2版本如何处理？
  - 是否提供polyfill或降级渲染？
  - 版本检测机制是什么？
- **建议**: 补充版本兼容性矩阵和降级策略

#### 模糊点 #3: 中文竖排支持
- **原文**: "CJK字体、竖排支持"
- **问题**:
  - 竖排是全局还是局部支持？
  - 竖排混排横排的场景如何处理？
  - 需要哪些特定LaTeX宏包？
- **建议**: 补充竖排实现细节和限制条件

### 2.5 边界场景缺口（当前覆盖率: 0/10 = 0%）

- [ ] 超大文件处理 (>100MB Markdown)
- [ ] 循环引用检测 (Markdown互相引用)
- [ ] 网络超时处理 (图片下载失败)
- [ ] 磁盘空间不足处理
- [ ] 并发文件锁处理
- [ ] 模板语法错误处理
- [ ] 字体缺失回退处理
- [ ] LaTeX编译超时处理
- [ ] Mermaid渲染失败降级
- [ ] 内存溢出防护

### 2.6 缺失功能场景分析

#### 高优先级缺失（P0级别）

| 缺失场景 | 影响程度 | 业务价值 | 建议处理 |
|---------|---------|---------|---------|
| 批量模式配置 | 高 | 高 | 需补充YAML批量配置规范 |
| 错误恢复机制 | 高 | 高 | 需定义失败文件处理策略 |
| 增量转换 | 中 | 高 | 需说明变更检测逻辑 |
| 输出目录结构 | 中 | 中 | 需定义目录组织规则 |

#### 中优先级缺失（P1级别）

| 缺失场景 | 影响程度 | 业务价值 | 建议处理 |
|---------|---------|---------|---------|
| 模板继承系统 | 中 | 中 | 需定义模板覆盖机制 |
| 水印功能 | 低 | 中 | 建议作为P2功能 |
| 页眉页脚动态内容 | 中 | 中 | 需补充变量系统 |
| PDF合并/拆分 | 低 | 低 | 建议作为P2功能 |

### 2.7 建议补充的默认配置项

```yaml
# 建议补充的默认配置项
conversion:
  parallel:
    max_workers: 8          # 最大并发数
    cpu_threshold: 80       # CPU阈值(%)
    memory_limit: 4096      # 内存限制(MB)
  timeout:
    mermaid_render: 30      # Mermaid渲染超时(秒)
    latex_compile: 120      # LaTeX编译超时(秒)
    image_download: 10      # 图片下载超时(秒)
  retry:
    max_attempts: 3         # 最大重试次数
    backoff_factor: 2       # 退避因子
  
fonts:
  cjk:
    primary: "Noto Sans CJK SC"
    fallback: ["WenQuanYi Micro Hei", "Source Han Sans"]
  
output:
  optimize: true            # 启用PDF优化
  compression: "medium"     # 压缩级别
  metadata: true            # 保留元数据
```

---

## 三、EXECUTION - 执行路线图

### 3.1 开发时间线

```
┌─────────────────────────────────────────────────────────────────┐
│                    MD2PDF Pro 开发时间线                          │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────┤
│   第1-2天   │   第3-4天   │   第5天     │   第6天     │ 第7-9天 │
│  环境搭建    │  核心模块    │  集成测试   │  CLI开发    │ 收尾发布 │
│  基础架构    │  开发       │  调试       │  完善       │        │
├─────────────┴─────────────┴─────────────┴─────────────┴─────────┤
│  M1:环境就绪 │ M2:核心完成 │ M3:功能可用 │ M4:CLI完整 │ M5:发布 │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────┘
```

### 3.2 阶段划分与里程碑

| 阶段 | 名称 | 工时 | 里程碑 | 交付物 |
|------|------|------|--------|--------|
| 1 | 环境搭建与基础架构 | 16h | M1: 环境就绪 | 项目骨架、配置模块 |
| 2 | 核心转换模块开发 | 16h | M2: 核心完成 | Mermaid预处理器、Pandoc转换器 |
| 3 | 并行处理与集成测试 | 8h | M3: 功能可用 | 批量处理器、测试套件 |
| 4 | CLI命令行开发 | 8h | M4: CLI完整 | 完整CLI接口 |
| 5 | 高级功能与优化 | 16h | M5: 生产就绪 | Watch模式、性能优化 |
| 6 | 文档编写与项目发布 | 8h | 发布上线 | 完整文档、PyPI发布 |

### 3.3 详细任务分解

#### 阶段一：环境搭建与基础架构（第1-2天 | 16工时）

> **里程碑 M1**: 开发环境完全就绪，项目骨架搭建完成

##### 任务 1.1: 项目初始化与目录结构

| 子任务 | 描述 | 预估工时 | 优先级 |
|--------|------|----------|--------|
| 1.1.1 | 创建项目目录结构 | 0.5h | P0 |
| 1.1.2 | 初始化Git仓库，配置.gitignore | 0.5h | P0 |
| 1.1.3 | 创建README.md基础模板 | 0.5h | P1 |
| 1.1.4 | 设置LICENSE文件 | 0.5h | P2 |

**目录结构设计：**
```
md2pdf-pro/
├── src/md2pdf_pro/          # 主包目录
│   ├── __init__.py
│   ├── config.py            # 配置模块
│   ├── preprocessor.py      # Mermaid预处理器
│   ├── converter.py         # Pandoc转换器
│   ├── parallel.py          # 并行处理器
│   ├── cli.py               # 命令行接口
│   ├── watcher.py           # 文件监控
│   └── filters/             # Pandoc过滤器
│       └── mermaid.lua
├── tests/                   # 测试目录
├── docs/                    # 文档目录
├── examples/                # 示例文件
├── scripts/                 # 辅助脚本
├── requirements.txt         # Python依赖
├── pyproject.toml          # 项目配置
└── Makefile                # 构建脚本
```

##### 任务 1.2: 系统依赖安装

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 1.2.1 | 安装Homebrew基础依赖（pandoc, tectonic, graphviz, librsvg, node） | 2h | P0 | ⚠️ 网络依赖 |
| 1.2.2 | 安装Node.js工具链（mermaid-cli） | 0.5h | P0 | 依赖1.2.1 |
| 1.2.3 | 验证所有系统依赖版本兼容性 | 0.5h | P0 | 依赖1.2.2 |

**安装命令：**
```bash
# 1. 系统级依赖 (Homebrew)
brew install pandoc tectonic graphviz librsvg python@3.11 node

# 2. Node.js工具链
npm install -g @mermaid-js/mermaid-cli

# 3. 验证安装
./scripts/doctor.sh
```

##### 任务 1.3: Python虚拟环境与依赖

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 1.3.1 | 创建Python 3.11虚拟环境 | 0.5h | P0 | - |
| 1.3.2 | 安装Python核心依赖（typer, rich, pydantic, pyyaml） | 1h | P0 | 依赖1.3.1 |
| 1.3.3 | 安装异步依赖（aiofiles, aiohttp） | 0.5h | P0 | 依赖1.3.2 |
| 1.3.4 | 安装开发依赖（pytest, black, mypy） | 0.5h | P1 | 依赖1.3.2 |
| 1.3.5 | 编写requirements.txt和pyproject.toml | 0.5h | P1 | 依赖1.3.4 |

**核心依赖列表：**
```
typer >= 0.9.0
rich >= 13.0.0
pydantic >= 2.0.0
pyyaml >= 6.0
aiofiles >= 23.0.0
aiohttp >= 3.8.0
watchdog >= 3.0.0
```

##### 任务 1.4: 配置模块开发（config.py）

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 1.4.1 | 设计MermaidConfig Pydantic模型 | 1h | P0 | - |
| 1.4.2 | 设计PandocConfig Pydantic模型 | 1h | P0 | - |
| 1.4.3 | 设计ProcessingConfig Pydantic模型 | 1h | P0 | - |
| 1.4.4 | 设计ProjectConfig主配置模型 | 1h | P0 | 依赖1.4.1-1.4.3 |
| 1.4.5 | 实现YAML配置文件加载/保存 | 1h | P0 | 依赖1.4.4 |
| 1.4.6 | 编写配置模块单元测试 | 1h | P1 | 依赖1.4.5 |

**配置模型设计：**
```python
# 核心配置类关系
MermaidConfig ──┐
PandocConfig ───┼──► ProjectConfig
ProcessingConfig─┘
```

**阶段一小计：16工时**

---

#### 阶段二：核心转换模块开发（第3-4天 | 16工时）

> **里程碑 M2**: 核心转换功能完成，单个文件转换可用

##### 任务 2.1: Mermaid预处理器（preprocessor.py）

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 2.1.1 | 实现Markdown代码块解析器 | 1.5h | P0 | 依赖1.4 |
| 2.1.2 | 实现Mermaid代码块识别与提取 | 1h | P0 | 依赖2.1.1 |
| 2.1.3 | 集成mmdc调用生成PDF矢量图 | 2h | P0 | 依赖2.1.2 |
| 2.1.4 | 实现图表缓存机制（基于内容Hash） | 1.5h | P1 | 依赖2.1.3 |
| 2.1.5 | 实现Markdown内容替换（代码块→图片引用） | 1h | P0 | 依赖2.1.3 |
| 2.1.6 | 编写预处理器单元测试 | 1h | P1 | 依赖2.1.5 |

**技术要点：**
- 使用正则表达式匹配```mermaid代码块
- 缓存目录：`~/.cache/md2pdf/mermaid/`
- Hash算法：SHA256(content)[:16]

**核心代码结构：**
```python
class MermaidPreprocessor:
    """将Mermaid代码块渲染为PDF矢量图"""
    
    MERMAID_REGEX = re.compile(r'```mermaid\s*\n(.*?)```', re.DOTALL)
    
    async def process(self, content: str, file_id: str) -> Tuple[str, list]:
        """替换markdown中的mermaid代码块为图片引用"""
        
    async def _render_mermaid(self, code: str, output_path: Path):
        """调用mmdc生成PDF (矢量图，无质量损失)"""
```

##### 任务 2.2: Pandoc转换器（converter.py）

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 2.2.1 | 设计异步Pandoc引擎封装类 | 1h | P0 | 依赖1.4 |
| 2.2.2 | 实现Pandoc参数构建器 | 1h | P0 | 依赖2.2.1 |
| 2.2.3 | 实现异步subprocess调用Pandoc | 1.5h | P0 | 依赖2.2.2 |
| 2.2.4 | 集成Tectonic作为PDF引擎 | 1h | P0 | 依赖2.2.3 |
| 2.2.5 | 实现错误处理和日志记录 | 1h | P0 | 依赖2.2.4 |
| 2.2.6 | 编写转换器单元测试 | 1h | P1 | 依赖2.2.5 |

**技术要点：**
- 使用`asyncio.create_subprocess_exec`异步调用
- 支持YAML Front Matter解析
- 错误码映射和友好错误提示

**核心代码结构：**
```python
class PandocEngine:
    def __init__(self, config: PandocConfig):
        self.config = config
        
    async def convert(self, input_file: Path, output_file: Path, metadata: Optional[Dict] = None) -> bool:
        """异步调用pandoc进行转换"""
```

##### 任务 2.3: Lua过滤器开发（filters/mermaid.lua）

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 2.3.1 | 学习Pandoc Lua过滤器基础 | 1h | P0 | - |
| 2.3.2 | 实现Image节点处理过滤器 | 1.5h | P0 | 依赖2.3.1 |
| 2.3.3 | 实现PDF矢量图嵌入支持 | 1h | P0 | 依赖2.3.2 |
| 2.3.4 | 测试过滤器与Pandoc集成 | 1h | P1 | 依赖2.3.3 |

**阶段二小计：16工时**

---

#### 阶段三：并行处理与集成测试（第5天 | 8工时）

> **里程碑 M3**: 批量转换功能可用，基础性能达标

##### 任务 3.1: 并行处理器（parallel.py）

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 3.1.1 | 设计批量处理器架构 | 1h | P0 | 依赖2.2 |
| 3.1.2 | 实现asyncio.Semaphore并发控制（默认8） | 1h | P0 | 依赖3.1.1 |
| 3.1.3 | 集成Rich进度条显示 | 1h | P0 | 依赖3.1.2 |
| 3.1.4 | 实现批量文件收集和过滤 | 0.5h | P0 | 依赖3.1.3 |
| 3.1.5 | 实现错误文件跳过和重试机制 | 1h | P1 | 依赖3.1.4 |
| 3.1.6 | 实现批量处理结果汇总 | 0.5h | P1 | 依赖3.1.5 |

**并发模型：**
```
┌─────────────────────────────────────────┐
│           批量处理器 (parallel.py)        │
├─────────────────────────────────────────┤
│  文件队列 ──► Semaphore(8) ──► 转换任务  │
│                │                        │
│                ▼                        │
│           Rich进度条显示                  │
└─────────────────────────────────────────┘
```

**核心代码结构：**
```python
class BatchProcessor:
    def __init__(self, max_workers: int = 8):
        self.semaphore = asyncio.Semaphore(max_workers)
        self.progress = Progress()
        
    async def process_batch(self, files: List[Path], process_fn: Callable, task_name: str):
        """批量处理文件，带进度条"""
```

##### 任务 3.2: 端到端集成测试

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 3.2.1 | 创建测试Markdown文件集 | 1h | P0 | 依赖2.x, 3.1 |
| 3.2.2 | 执行单文件转换测试 | 0.5h | P0 | 依赖3.2.1 |
| 3.2.3 | 执行批量转换测试（10/50/100文件） | 1h | P0 | 依赖3.2.2 |
| 3.2.4 | 性能基准测试和调优 | 1h | P1 | 依赖3.2.3 |

**测试场景：**
- 单文件转换（含Mermaid、LaTeX公式、代码块）
- 批量10文件转换
- 批量50文件转换
- 批量100文件转换（性能基准）

**阶段三小计：8工时**

---

#### 阶段四：CLI命令行开发（第6天 | 8工时）

> **里程碑 M4**: CLI功能完整，用户可直接使用

##### 任务 4.1: Typer CLI基础框架（cli.py）

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 4.1.1 | 设计CLI命令结构 | 0.5h | P0 | 依赖3.x |
| 4.1.2 | 实现convert命令（单文件转换） | 1.5h | P0 | 依赖4.1.1 |
| 4.1.3 | 实现batch命令（批量转换） | 1.5h | P0 | 依赖4.1.2 |
| 4.1.4 | 实现config命令（配置管理） | 1h | P1 | 依赖4.1.3 |

##### 任务 4.2: CLI增强功能

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 4.2.1 | 实现全局选项（--verbose, --config） | 1h | P0 | 依赖4.1 |
| 4.2.2 | 实现输入/输出路径参数处理 | 1h | P0 | 依赖4.2.1 |
| 4.2.3 | 集成Rich美化输出和错误提示 | 1h | P1 | 依赖4.2.2 |
| 4.2.4 | 实现--help详细文档 | 0.5h | P1 | 依赖4.2.3 |

**CLI命令结构：**
```bash
md2pdf convert <input.md> [options]      # 单文件转换
md2pdf batch <input_dir> [options]       # 批量转换
md2pdf config init                       # 初始化配置
md2pdf config show                       # 显示配置
md2pdf watch <dir> [options]             # 监听模式（阶段五）
md2pdf doctor                            # 环境检查
```

**核心代码结构：**
```python
import typer

app = typer.Typer(help="MD2PDF Pro - 批量Markdown转PDF工具")

@app.command()
def convert(
    files: List[Path] = typer.Argument(..., help="Markdown文件或通配符"),
    output: Path = typer.Option("./output", "--output", "-o"),
    config: Optional[Path] = typer.Option(None, "--config", "-c"),
    workers: int = typer.Option(8, "--workers", "-w"),
    watch: bool = typer.Option(False, "--watch", help="监听模式")
):
    """转换Markdown文件为PDF"""
```

**阶段四小计：8工时**

---

#### 阶段五：高级功能与优化（第7-8天 | 16工时）

> **里程碑 M5**: 生产就绪，包含监听模式、性能优化

##### 任务 5.1: 文件监控监听模式（watcher.py）

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 5.1.1 | 集成watchdog文件监控库 | 1h | P1 | 依赖4.x |
| 5.1.2 | 实现文件变化检测逻辑 | 1h | P1 | 依赖5.1.1 |
| 5.1.3 | 实现自动转换触发 | 1h | P1 | 依赖5.1.2 |
| 5.1.4 | 实现防抖机制（避免频繁触发） | 1h | P1 | 依赖5.1.3 |
| 5.1.5 | 添加watch命令到CLI | 0.5h | P1 | 依赖5.1.4 |

##### 任务 5.2: 性能优化与缓存增强

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 5.2.1 | 优化Mermaid渲染缓存策略 | 1h | P2 | 依赖5.1 |
| 5.2.2 | 实现转换结果缓存（跳过未变更文件） | 1.5h | P2 | 依赖5.2.1 |
| 5.2.3 | 优化并发参数自适应调整 | 1h | P2 | 依赖5.2.2 |
| 5.2.4 | 内存使用优化 | 1h | P2 | 依赖5.2.3 |

##### 任务 5.3: 错误处理与日志系统

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 5.3.1 | 设计统一错误码体系 | 0.5h | P1 | - |
| 5.3.2 | 实现结构化日志记录 | 1h | P1 | 依赖5.3.1 |
| 5.3.3 | 添加详细的错误上下文信息 | 1h | P1 | 依赖5.3.2 |
| 5.3.4 | 实现日志文件轮转 | 0.5h | P2 | 依赖5.3.3 |

**错误码体系：**
```python
class ErrorCode(Enum):
    SUCCESS = 0
    INVALID_ARGS = 1
    CONVERSION_FAILED = 2
    DEPENDENCY_MISSING = 3
    CONFIG_ERROR = 4
    TIMEOUT = 5
```

**日志格式规范：**
```yaml
log_format:
  timestamp: ISO8601
  level: INFO/ERROR/WARNING
  file: 输入文件名
  stage: preprocess/convert/cleanup
  duration_ms: 处理耗时
  error: 错误详情 (如有)
```

##### 任务 5.4: 测试覆盖与CI/CD

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 5.4.1 | 补充单元测试（目标80%覆盖） | 2h | P1 | 依赖5.3 |
| 5.4.2 | 编写集成测试用例 | 1h | P1 | 依赖5.4.1 |
| 5.4.3 | 配置GitHub Actions CI | 1h | P2 | 依赖5.4.2 |
| 5.4.4 | 配置自动化发布流程 | 0.5h | P2 | 依赖5.4.3 |

**阶段五小计：16工时**

---

#### 阶段六：文档编写与项目发布（第9天 | 8工时）

> **发布里程碑**: 项目可交付，文档完整

##### 任务 6.1: 用户文档编写

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 6.1.1 | 编写安装指南（README） | 1h | P0 | - |
| 6.1.2 | 编写使用教程和示例 | 1.5h | P0 | 依赖6.1.1 |
| 6.1.3 | 编写CLI命令参考文档 | 1h | P0 | 依赖6.1.2 |
| 6.1.4 | 编写配置说明文档 | 1h | P1 | 依赖6.1.3 |

##### 任务 6.2: 开发者文档与示例

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 6.2.1 | 编写架构设计文档 | 1h | P1 | - |
| 6.2.2 | 编写API文档（docstring） | 1h | P1 | 依赖6.2.1 |
| 6.2.3 | 创建示例项目 | 0.5h | P2 | 依赖6.2.2 |
| 6.2.4 | 编写贡献指南 | 0.5h | P2 | 依赖6.2.3 |

##### 任务 6.3: 发布准备

| 子任务 | 描述 | 预估工时 | 优先级 | 阻塞点 |
|--------|------|----------|--------|--------|
| 6.3.1 | 最终测试验证 | 0.5h | P0 | 依赖6.x |
| 6.3.2 | 打包发布到PyPI | 0.5h | P0 | 依赖6.3.1 |
| 6.3.3 | 创建GitHub Release | 0.5h | P1 | 依赖6.3.2 |

**阶段六小计：8工时**

### 3.4 任务依赖关系图

```
阶段一：环境搭建
├── 1.1 项目初始化 ──────────────────────────────────────┐
├── 1.2 系统依赖 ────────────────────────────────────────┤
├── 1.3 Python环境 ──────────────────────────────────────┤
└── 1.4 配置模块 ────────────────────────────────────────┴──► 阶段二

阶段二：核心模块
├── 2.1 Mermaid预处理器 ─────────────────────────────────┐
├── 2.2 Pandoc转换器 ────────────────────────────────────┤
└── 2.3 Lua过滤器 ───────────────────────────────────────┴──► 阶段三

阶段三：并行处理
├── 3.1 并行处理器 ──────────────────────────────────────┐
└── 3.2 集成测试 ────────────────────────────────────────┴──► 阶段四

阶段四：CLI开发
└── 4.x CLI命令 ───────────────────────────────────────────► 阶段五

阶段五：高级功能
├── 5.1 文件监控 ────────────────────────────────────────┐
├── 5.2 性能优化 ────────────────────────────────────────┤
├── 5.3 错误处理 ────────────────────────────────────────┤
└── 5.4 测试覆盖 ────────────────────────────────────────┴──► 阶段六

阶段六：文档发布
└── 6.x 文档与发布
```

### 3.5 关键路径识别

**关键路径总时长：约 52 工时（6.5个工作日）**

```
1.1 项目初始化 (2h)
    ↓
1.2 系统依赖 (3h) ─────────────────────────────────────────────┐
    ↓                                                          │
1.3 Python环境 (3h)                                            │
    ↓                                                          │
1.4 配置模块 (6h) ◄────────────────────────────────────────────┘
    ↓
2.1 Mermaid预处理器 (8h)
    ↓
2.2 Pandoc转换器 (7.5h)
    ↓
3.1 并行处理器 (5.5h)
    ↓
4.1 CLI基础框架 (4.5h)
    ↓
6.1 用户文档 (4.5h)
    ↓
6.3 发布准备 (1.5h)
```

**关键路径说明：**

| 序号 | 关键任务 | 浮动时间 | 风险等级 |
|------|----------|----------|----------|
| 1 | 系统依赖安装 | 0h | 🔴 高 |
| 2 | 配置模块开发 | 0h | 🔴 高 |
| 3 | Mermaid预处理器 | 0h | 🔴 高 |
| 4 | Pandoc转换器 | 0h | 🔴 高 |
| 5 | 并行处理器 | 0h | 🟡 中 |
| 6 | CLI基础框架 | 0h | 🟡 中 |

### 3.6 可并行任务

```
阶段一内并行：
├── 1.1 项目初始化 (2h) ──┐
├── 1.2 系统依赖 (3h) ────┤──► 可并行执行
└── 1.3 Python环境 (3h) ──┘

阶段二内并行：
├── 2.1 Mermaid预处理器 (8h) ──┐
└── 2.3 Lua过滤器 (4.5h) ──────┘──► 部分可并行

阶段五内并行：
├── 5.1 文件监控 (4.5h) ──┐
├── 5.2 性能优化 (4.5h) ──┤──► 可并行执行
└── 5.3 错误处理 (3h) ────┘
```

### 3.7 每日工作安排建议

| 天数 | 上午（4h） | 下午（4h） | 晚上（可选） |
|------|-----------|-----------|-------------|
| 第1天 | 1.1项目初始化 + 1.2系统依赖 | 1.3Python环境 + 1.4配置模块开始 | - |
| 第2天 | 1.4配置模块完成 + 测试 | 2.1Mermaid预处理器开始 | - |
| 第3天 | 2.1Mermaid预处理器完成 | 2.2Pandoc转换器 | - |
| 第4天 | 2.2Pandoc转换器完成 + 2.3Lua过滤器 | 2.3完成 + 测试 | - |
| 第5天 | 3.1并行处理器 | 3.2集成测试 + 性能测试 | - |
| 第6天 | 4.1CLI基础框架 | 4.2CLI增强功能 | - |
| 第7天 | 5.1文件监控 + 5.2性能优化 | 5.2性能优化 + 5.3错误处理 | - |
| 第8天 | 5.3错误处理 + 5.4测试覆盖 | 5.4完成 + CI/CD配置 | - |
| 第9天 | 6.1用户文档 | 6.2开发者文档 + 6.3发布 | - |

---

## 四、PERFORMANCE - 性能策略

### 4.1 并发和并行策略优化

#### 4.1.1 分层并发架构

```
┌─────────────────────────────────────────────────────────────┐
│                    全局并发控制器                            │
│              (max_concurrency = CPU核心数 × 2)               │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ I/O 任务池   │  │ CPU 任务池   │  │ 混合任务池   │      │
│  │ (asyncio)    │  │ (ProcessPool)│  │ (Hybrid)     │      │
│  │ semaphore=16 │  │ max_workers=4│  │ adaptive     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

#### 4.1.2 动态并发控制

```python
@dataclass
class ConcurrencyConfig:
    """动态并发配置"""
    # I/O密集型任务（网络请求、文件读写）
    io_semaphore_limit: int = 16
    
    # CPU密集型任务（PDF渲染、Mermaid转换）
    cpu_max_workers: int = max(mp.cpu_count() - 1, 2)
    
    # 混合任务自适应阈值
    adaptive_threshold_ms: float = 100.0
    
    # 批处理大小
    batch_size: int = 10

class AdaptiveConcurrencyManager:
    """自适应并发管理器"""
    
    async def execute_io_task(self, coro, *args, **kwargs):
        """执行I/O密集型任务"""
        async with self.io_semaphore:
            # 执行任务并记录性能统计
            
    async def execute_cpu_task(self, func, *args, **kwargs):
        """执行CPU密集型任务"""
        # 使用ProcessPool执行
```

#### 4.1.3 任务分类与调度

| 任务类型 | 示例 | 执行方式 | 并发限制 |
|---------|------|---------|---------|
| I/O密集型 | 图片下载、文件读取 | asyncio协程 | 16 |
| CPU密集型 | Mermaid渲染、PDF生成 | ProcessPool | CPU核心数-1 |
| 混合类型 | Markdown解析+图片处理 | 混合调度 | 动态调整 |
| 阻塞型 | Tectonic编译 | 独立子进程 | 4 |

#### 4.1.4 并发性能目标

| 指标 | 目标值 | 测量方法 |
|-----|-------|---------|
| 并发任务数 | 16个I/O + 4个CPU | 实时监控 |
| 任务切换延迟 | < 5ms | asyncio性能分析 |
| 进程创建开销 | < 100ms | 时间测量 |
| 资源争用率 | < 10% | CPU/内存监控 |

### 4.2 内存管理和垃圾回收策略

#### 4.2.1 内存分层架构

```
┌─────────────────────────────────────────────────────────┐
│                    内存使用分层                          │
├─────────────────────────────────────────────────────────┤
│  L1: 热数据 (Hot)    │ 当前处理文件 + 活跃缓存          │
│  L2: 温数据 (Warm)   │ 最近使用缓存 + 预处理结果        │
│  L3: 冷数据 (Cold)   │ 持久化缓存文件                   │
│  L4: 交换区 (Swap)   │ 磁盘溢出（内存不足时）           │
└─────────────────────────────────────────────────────────┘
```

#### 4.2.2 内存池管理

```python
@dataclass
class MemoryThresholds:
    """内存阈值配置"""
    warning_percent: float = 70.0   # 警告阈值
    critical_percent: float = 85.0  # 临界阈值
    emergency_percent: float = 95.0 # 紧急阈值
    target_percent: float = 60.0    # 目标使用率

class MemoryManager:
    """内存管理器"""
    
    def check_memory_pressure(self) -> str:
        """检查内存压力级别"""
        # 返回: normal/warning/critical/emergency
        
    def optimize_memory(self, pressure_level: str):
        """根据压力级别执行内存优化"""
        # emergency: 强制GC + 清理所有缓存
        # critical: 激进清理 + 释放缓存
        # warning: 温和清理
```

#### 4.2.3 流式处理优化

```python
class StreamingProcessor:
    """流式处理器 - 控制单文件内存占用"""
    
    CHUNK_SIZE = 64 * 1024  # 64KB 块大小
    MAX_IN_MEMORY_SIZE = 10 * 1024 * 1024  # 10MB 内存阈值
    
    async def process_large_file(self, file_path: str, processor_fn):
        """处理大文件"""
        file_size = os.path.getsize(file_path)
        
        if file_size <= self.MAX_IN_MEMORY_SIZE:
            # 小文件：直接读取处理
            async with aiofiles.open(file_path, 'rb') as f:
                content = await f.read()
                return await processor_fn(content)
        else:
            # 大文件：流式处理
            return await self._stream_process(file_path, processor_fn)
```

#### 4.2.4 内存性能目标

| 指标 | 目标值 | 优化策略 |
|-----|-------|---------|
| 单文件峰值内存 | < 500MB | 流式处理 |
| 内存泄漏检测 | 0泄漏 | 弱引用监控 |
| GC暂停时间 | < 50ms | 分代回收 |
| 内存碎片率 | < 15% | 内存池管理 |

### 4.3 缓存策略细化

#### 4.3.1 多级缓存架构

```
┌────────────────────────────────────────────────────────────┐
│                     缓存层级结构                            │
├────────────────────────────────────────────────────────────┤
│  L1: 内存缓存 (LRU)    │ 10MB │ < 1ms  │ 热数据           │
│  L2: 磁盘缓存 (SQLite) │ 1GB  │ < 10ms │ 温数据           │
│  L3: 文件系统缓存      │ 10GB │ < 50ms │ 冷数据           │
└────────────────────────────────────────────────────────────┘
```

#### 4.3.2 专用缓存策略

| 缓存类型 | TTL | 淘汰策略 | 最大大小 | 压缩 | 目标命中率 |
|---------|-----|---------|---------|------|-----------|
| Mermaid图表 | 24h | LRU | 500MB | 是 | > 85% |
| 图片下载 | 7d | LFU | 2GB | 否 | > 85% |
| LaTeX包 | 30d | FIFO | 5GB | 是 | - |
| PDF模板 | 1h | LRU | 50MB | 是 | > 90% |

#### 4.3.3 智能缓存管理器

```python
@dataclass
class CachePolicy:
    """缓存策略配置"""
    ttl_seconds: int = 3600
    max_size_mb: float = 100.0
    eviction_policy: str = "lru"  # lru/lfu/fifo
    compression: bool = True

class SmartCacheManager:
    """智能缓存管理器"""
    
    def _compute_key(self, content: str) -> str:
        """计算内容哈希作为缓存键"""
        return hashlib.sha256(content.encode()).hexdigest()[:32]
    
    async def get(self, key: str, compute_fn: Callable = None) -> Optional[bytes]:
        """获取缓存值（带自动计算）"""
        # L1 → L2 → L3 → compute_fn
```

### 4.4 资源监控方案

#### 4.4.1 监控指标体系

```python
class MetricsCollector:
    """指标收集器"""
    
    THRESHOLDS = {
        "cpu_percent": MetricThreshold(70, 85, 95),
        "memory_percent": MetricThreshold(70, 85, 95),
        "disk_io_mbps": MetricThreshold(100, 200, 500),
        "task_queue_size": MetricThreshold(50, 100, 200),
        "error_rate": MetricThreshold(0.01, 0.05, 0.10),
        "cache_hit_rate": MetricThreshold(0.70, 0.60, 0.50),
    }
```

#### 4.4.2 关键监控指标

| 指标类别 | 指标名称 | 警告阈值 | 临界阈值 | 紧急阈值 |
|---------|---------|---------|---------|---------|
| CPU | 使用率 | 70% | 85% | 95% |
| 内存 | 使用率 | 70% | 85% | 95% |
| 磁盘 | I/O速率 | 100MB/s | 200MB/s | 500MB/s |
| 任务 | 队列长度 | 50 | 100 | 200 |
| 错误 | 错误率 | 1% | 5% | 10% |
| 缓存 | 命中率 | 70% | 60% | 50% |

#### 4.4.3 告警系统

```python
class AlertManager:
    """告警管理器"""
    
    ALERT_CHANNELS = {
        "warning": ["log", "metrics"],
        "critical": ["log", "metrics", "notification"],
        "emergency": ["log", "metrics", "notification", "pager"]
    }
```

### 4.5 性能测试方案

#### 4.5.1 测试用例设计

```python
@dataclass
class PerformanceTestCase:
    """性能测试用例"""
    name: str
    file_count: int
    file_size_mb: float
    mermaid_count: int
    image_count: int
    expected_time_sec: float
    expected_memory_mb: float
    expected_success_rate: float

# 标准测试用例
TEST_CASES = [
    PerformanceTestCase(
        name="small_batch",
        file_count=10, file_size_mb=0.5,
        mermaid_count=2, image_count=3,
        expected_time_sec=15, expected_memory_mb=500,
        expected_success_rate=1.0
    ),
    PerformanceTestCase(
        name="medium_batch",
        file_count=50, file_size_mb=1.0,
        mermaid_count=3, image_count=5,
        expected_time_sec=60, expected_memory_mb=1500,
        expected_success_rate=0.99
    ),
    PerformanceTestCase(
        name="large_batch_spec",
        file_count=100, file_size_mb=2.0,
        mermaid_count=5, image_count=8,
        expected_time_sec=120, expected_memory_mb=4000,
        expected_success_rate=0.98
    ),
    PerformanceTestCase(
        name="stress_test",
        file_count=500, file_size_mb=5.0,
        mermaid_count=10, image_count=15,
        expected_time_sec=600, expected_memory_mb=8000,
        expected_success_rate=0.95
    ),
]
```

#### 4.5.2 性能基准目标矩阵

| 测试场景 | 文件数 | 总耗时 | 内存峰值 | 成功率 | CPU利用率 |
|---------|-------|-------|---------|-------|----------|
| 小规模 | 10 | < 15s | < 500MB | 100% | > 60% |
| 中等规模 | 50 | < 60s | < 1.5GB | > 99% | > 70% |
| **SPEC基准** | **100** | **< 120s** | **< 4GB** | **> 98%** | **> 75%** |
| 压力测试 | 500 | < 600s | < 8GB | > 95% | > 80% |

### 4.6 性能调优检查清单

#### 4.6.1 部署前检查

```markdown
## 性能调优检查清单

### 并发配置
- [ ] 信号量限制已根据CPU核心数调整
- [ ] 进程池大小设置为 CPU核心数 - 1
- [ ] 批处理大小经过测试验证
- [ ] 任务分类正确（I/O/CPU/混合）

### 内存管理
- [ ] 内存阈值配置合理（警告70%/临界85%/紧急95%）
- [ ] 流式处理已启用（单文件<500MB）
- [ ] 垃圾回收策略已配置
- [ ] 内存池已注册关键资源

### 缓存配置
- [ ] Mermaid缓存TTL设置为24小时
- [ ] 图片缓存TTL设置为7天
- [ ] 缓存大小限制已配置
- [ ] 淘汰策略已选择（推荐LRU）
- [ ] 缓存目录权限正确

### 监控告警
- [ ] 关键指标监控已启用
- [ ] 告警阈值已配置
- [ ] 告警渠道已测试
- [ ] Dashboard已部署

### 性能测试
- [ ] 小规模测试通过（10文件）
- [ ] 中等规模测试通过（50文件）
- [ ] SPEC基准测试通过（100文件）
- [ ] 压力测试完成（500文件）
- [ ] 性能报告已生成
```

#### 4.6.2 性能优化决策树

```
性能问题？
├── 内存过高？
│   ├── 是 → 启用流式处理 → 降低批处理大小 → 增加GC频率
│   └── 否 → 继续
├── CPU利用率低？
│   ├── 是 → 增加并发数 → 检查I/O阻塞 → 优化任务分类
│   └── 否 → 继续
├── 处理速度慢？
│   ├── 是 → 检查缓存命中率 → 优化热点代码 → 增加资源
│   └── 否 → 继续
└── 错误率高？
    ├── 是 → 检查资源限制 → 增加重试机制 → 降级处理
    └── 否 → 系统正常
```

### 4.7 关键可量化目标汇总

| 指标 | 目标值 |
|-----|-------|
| 总耗时（100文件） | < 120秒 |
| 内存峰值 | < 4GB |
| CPU利用率 | > 75% |
| 成功率 | > 98% |
| 缓存命中率 | > 85% |
| 任务切换延迟 | < 5ms |
| GC暂停时间 | < 50ms |

---

## 五、COMPLETION - 完成标准

### 5.1 功能验收标准

#### 5.1.1 CLI命令行模块

| 检查项 | 通过标准 | 优先级 |
|--------|----------|--------|
| ✅ `md2pdf convert` 基础转换 | 单文件Markdown成功转为PDF，输出文件存在且非空 | P0 |
| ✅ `md2pdf convert --batch` 批量转换 | 同时处理≥10个文件无崩溃，全部成功输出 | P0 |
| ✅ `md2pdf convert --watch` 监控模式 | 文件修改后自动触发转换，延迟≤3秒 | P0 |
| ✅ `md2pdf convert --template` 模板选择 | 学术论文/技术文档/中文书籍模板正确应用 | P0 |
| ✅ `md2pdf doctor` 环境检查 | 正确检测pandoc/tectonic/mermaid-cli版本 | P0 |
| ✅ `md2pdf doctor --fix` 自动修复 | 尝试安装缺失依赖并报告结果 | P1 |
| ✅ 帮助文档 `--help` | 所有命令和参数有清晰说明 | P1 |
| ✅ 版本信息 `--version` | 显示当前版本和依赖版本 | P1 |
| ✅ 进度显示 | 批量处理时显示进度条和预计剩余时间 | P2 |
| ✅ 退出码规范 | 成功=0，参数错误=1，转换失败=2，依赖缺失=3 | P1 |

**失败标准**: 任何P0项未通过即视为功能验收失败

#### 5.1.2 配置管理模块

| 检查项 | 通过标准 | 优先级 |
|--------|----------|--------|
| ✅ YAML配置加载 | 有效YAML文件正确解析，无效文件给出明确错误 | P0 |
| ✅ Pydantic模型验证 | 配置项类型错误时提供字段级错误信息 | P0 |
| ✅ 默认配置回退 | 缺失配置项使用默认值，不崩溃 | P0 |
| ✅ 配置合并优先级 | CLI参数 > 配置文件 > 默认配置 | P0 |
| ✅ 配置热重载 | watch模式下配置修改自动生效 | P1 |
| ✅ 配置模板生成 | `md2pdf init` 生成有效配置模板 | P1 |
| ✅ 配置Schema导出 | 提供JSON Schema供IDE自动补全 | P2 |

#### 5.1.3 Mermaid预处理模块

| 检查项 | 通过标准 | 优先级 |
|--------|----------|--------|
| ✅ 流程图渲染 | 标准flowchart语法正确转为PDF内嵌图像 | P0 |
| ✅ 时序图渲染 | sequenceDiagram正确渲染 | P0 |
| ✅ 类图渲染 | classDiagram正确渲染 | P1 |
| ✅ 状态图渲染 | stateDiagram正确渲染 | P1 |
| ✅ 甘特图渲染 | gantt正确渲染 | P1 |
| ✅ 饼图渲染 | pie正确渲染 | P2 |
| ✅ 复杂图渲染 | 包含子图的复杂流程图正确渲染 | P1 |
| ✅ 中文支持 | Mermaid图中中文正常显示 | P0 |
| ✅ 错误处理 | 语法错误的Mermaid代码给出警告，不中断转换 | P0 |
| ✅ 缓存机制 | 相同Mermaid代码复用缓存图像 | P2 |

#### 5.1.4 异步Pandoc转换模块

| 检查项 | 通过标准 | 优先级 |
|--------|----------|--------|
| ✅ 基础Markdown转换 | 标准GFM语法正确转为PDF | P0 |
| ✅ LaTeX公式渲染 | 行内`$...$`和块级`$$...$$`公式正确渲染 | P0 |
| ✅ 表格渲染 | Markdown表格正确转为PDF表格 | P0 |
| ✅ 代码高亮 | 代码块带语法高亮 | P0 |
| ✅ 图片嵌入 | 本地图片和URL图片正确嵌入 | P0 |
| ✅ 中文排版 | 中文段落正确换行，标点符号符合规范 | P0 |
| ✅ 页眉页脚 | 配置中定义的页眉页脚正确显示 | P1 |
| ✅ 目录生成 | `--toc` 参数正确生成可点击目录 | P1 |
| ✅ 交叉引用 | 图表编号和引用正确 | P1 |
| ✅ 异步执行 | 转换不阻塞主线程，支持并发 | P0 |

#### 5.1.5 批量并行处理模块

| 检查项 | 通过标准 | 优先级 |
|--------|----------|--------|
| ✅ 并发控制 | `--jobs` 参数有效控制并发数 | P0 |
| ✅ 内存管理 | 处理100+文件时内存使用稳定 | P0 |
| ✅ 错误隔离 | 单个文件失败不影响其他文件处理 | P0 |
| ✅ 部分失败报告 | 批量处理结束后报告成功/失败统计 | P0 |
| ✅ 重试机制 | 失败任务支持自动重试(最多3次) | P1 |
| ✅ 取消操作 | Ctrl+C 优雅中断，清理临时文件 | P1 |
| ✅ 性能基准 | 10个文件批量处理时间 ≤ 单文件×3 | P1 |

#### 5.1.6 文件监控模块 (Watch模式)

| 检查项 | 通过标准 | 优先级 |
|--------|----------|--------|
| ✅ 文件变更检测 | 保存文件后3秒内触发转换 | P0 |
| ✅ 防抖处理 | 快速连续保存只触发一次转换 | P0 |
| ✅ 新增文件检测 | 新Markdown文件自动纳入监控 | P1 |
| ✅ 删除文件处理 | 源文件删除时清理对应PDF | P2 |
| ✅ 递归监控 | `--recursive` 监控子目录 | P1 |
| ✅ 排除模式 | `--ignore` 排除指定文件/目录 | P1 |
| ✅ 优雅退出 | 信号处理正确，无僵尸进程 | P0 |

### 5.2 测试覆盖率要求

#### 5.2.1 单元测试覆盖率

```
┌─────────────────────────────────────────────────────────┐
│  模块              │ 行覆盖率 │ 分支覆盖率 │ 函数覆盖率 │
├─────────────────────────────────────────────────────────┤
│  cli.py            │   ≥85%   │    ≥80%    │   ≥90%    │
│  config.py         │   ≥90%   │    ≥85%    │   ≥95%    │
│  preprocessor.py   │   ≥85%   │    ≥80%    │   ≥90%    │
│  converter.py      │   ≥85%   │    ≥80%    │   ≥90%    │
│  parallel.py       │   ≥80%   │    ≥75%    │   ≥85%    │
│  watcher.py        │   ≥75%   │    ≥70%    │   ≥80%    │
│  utils/*.py        │   ≥80%   │    ≥75%    │   ≥85%    │
├─────────────────────────────────────────────────────────┤
│  总体              │   ≥85%   │    ≥80%    │   ≥90%    │
└─────────────────────────────────────────────────────────┘
```

#### 5.2.2 集成测试要求

| 测试场景 | 通过标准 | 状态 |
|----------|----------|------|
| ✅ LaTeX公式渲染 | 复杂公式(矩阵、积分、求和)正确显示 | 必过 |
| ✅ Mermaid流程图 | 包含决策节点的流程图正确渲染 | 必过 |
| ✅ 批量处理稳定性 | 100个文件连续转换无内存泄漏 | 必过 |
| ✅ 模板系统 | 三种模板分别生成正确格式的PDF | 必过 |
| ✅ 中文内容 | 混合中英文文档正确排版 | 必过 |
| ✅ 大文件处理 | 10MB+ Markdown文件成功转换 | 必过 |
| ✅ 并发安全 | 多进程同时写入不同输出目录 | 必过 |
| ✅ 依赖版本兼容 | 最低版本和最新版本依赖均通过 | 必过 |

#### 5.2.3 端到端测试

| 测试用例 | 描述 | 通过标准 |
|----------|------|----------|
| ✅ E2E-001 | 完整工作流：初始化→配置→转换 | 全程无错误，输出符合预期 |
| ✅ E2E-002 | 学术论文章节模板 | 生成符合IEEE/ACM格式的PDF |
| ✅ E2E-003 | 技术文档模板 | 生成带侧边栏目录的技术文档 |
| ✅ E2E-004 | 中文书籍模板 | 正确分页、章节编号 |
| ✅ E2E-005 | Watch模式开发工作流 | 保存→自动转换→浏览器刷新 |

### 5.3 代码质量门禁

#### 5.3.1 Lint检查 (Ruff)

```yaml
ruff:
  规则集:
    - E: pycodestyle errors (必过)
    - F: Pyflakes (必过)
    - W: pycodestyle warnings (必过)
    - I: isort import排序 (必过)
    - N: pep8-naming (必过)
    - D: pydocstyle (警告)
    - UP: pyupgrade (必过)
    - B: flake8-bugbear (必过)
    - C4: flake8-comprehensions (必过)
    - SIM: flake8-simplify (警告)
  
  门禁条件:
    - E, F, W, B 规则: 0 错误
    - 其他规则: 警告数 ≤ 10
```

#### 5.3.2 类型检查 (mypy)

```yaml
mypy:
  严格模式: true
  必过条件:
    - error 数量: 0
    - 类型覆盖率: ≥95%
  
  豁免规则:
    - 第三方库无stub: 允许 # type: ignore
    - 每文件 ignore 数: ≤ 3
```

#### 5.3.3 代码格式化

```yaml
format:
  工具: black + ruff format
  配置:
    line-length: 88
    target-version: py311
  
  门禁条件:
    - CI检查: 格式化后无差异
    - 提交前: pre-commit自动格式化
```

#### 5.3.4 安全扫描

| 扫描工具 | 门禁条件 |
|----------|----------|
| bandit | High/Medium风险: 0 |
| safety | 已知CVE依赖: 0 |
| pip-audit | 高危漏洞: 0 |

#### 5.3.5 质量门禁汇总

```
┌────────────────────────────────────────────────────────┐
│                    代码质量门禁检查单                    │
├────────────────────────────────────────────────────────┤
│  □ Ruff Lint检查通过 (E,F,W,B = 0)                     │
│  □ mypy类型检查通过 (error = 0)                        │
│  □ 代码格式化检查通过                                   │
│  □ 安全扫描无高危问题                                   │
│  □ 测试覆盖率达标 (行覆盖率≥85%)                        │
│  □ 文档字符串覆盖率≥80%                                │
│  □ 循环复杂度≤10 (除特殊情况)                          │
│  □ 无代码重复 (DRY原则)                                │
└────────────────────────────────────────────────────────┘
```

### 5.4 文档交付检查清单

#### 5.4.1 README文档

| 检查项 | 通过标准 | 状态 |
|--------|----------|------|
| ✅ 项目简介 | 一句话描述项目用途 | 必含 |
| ✅ 功能特性 | 列出主要功能点 | 必含 |
| ✅ 安装说明 | Homebrew和pip两种安装方式 | 必含 |
| ✅ 快速开始 | 3步内完成首次转换 | 必含 |
| ✅ 使用示例 | 常见用例代码示例 | 必含 |
| ✅ 配置说明 | 配置文件字段说明 | 必含 |
| ✅ 模板列表 | 内置模板及用途 | 必含 |
| ✅ 依赖要求 | pandoc/tectonic/mermaid版本 | 必含 |
| ✅ 徽章 | CI状态、版本、许可证 | 必含 |
| ✅ 许可证 | LICENSE文件链接 | 必含 |

#### 5.4.2 API文档 (pdoc)

| 检查项 | 通过标准 |
|--------|----------|
| ✅ 模块文档 | 每个模块有模块级docstring |
| ✅ 类文档 | 每个公共类有类级docstring |
| ✅ 方法文档 | 每个公共方法有参数/返回值说明 |
| ✅ 类型注解 | 所有公共API有类型提示 |
| ✅ 示例代码 | 复杂功能提供使用示例 |
| ✅ 生成脚本 | `make docs` 一键生成 |
| ✅ 在线托管 | GitHub Pages自动部署 |

#### 5.4.3 用户手册

| 章节 | 内容要求 | 状态 |
|------|----------|------|
| ✅ 入门指南 | 安装、配置、第一次转换 | 必含 |
| ✅ 模板指南 | 三种模板的使用场景和配置 | 必含 |
| ✅ 高级功能 | watch模式、批量处理、自定义模板 | 必含 |
| ✅ 故障排除 | 常见问题及解决方案 | 必含 |
| ✅ LaTeX公式 | 支持的公式语法和示例 | 必含 |
| ✅ Mermaid图表 | 支持的图表类型和语法 | 必含 |
| ✅ 配置参考 | 完整配置选项说明 | 必含 |
| ✅ 最佳实践 | 性能优化、工作流建议 | 必含 |

#### 5.4.4 配置模板

| 模板 | 验收标准 |
|------|----------|
| ✅ 学术论文模板 | 支持IEEE/ACM格式，含摘要、关键词、参考文献 |
| ✅ 技术文档模板 | 支持侧边栏目录、代码高亮、警告框 |
| ✅ 中文书籍模板 | 支持章节编号、页眉页脚、中文排版 |

#### 5.4.5 其他文档

| 文档 | 通过标准 |
|------|----------|
| ✅ CHANGELOG.md | 版本历史，遵循Keep a Changelog |
| ✅ CONTRIBUTING.md | 贡献指南，含开发环境搭建 |
| ✅ CODE_OF_CONDUCT.md | 行为准则 |
| ✅ LICENSE | MIT或Apache-2.0许可证 |
| ✅ .github/ISSUE_TEMPLATE | Bug报告和功能请求模板 |

### 5.5 发布前验收流程

#### 5.5.1 Alpha阶段验收

```yaml
Alpha验收:
  准入条件:
    - 核心功能实现完成
    - 单元测试覆盖率≥70%
  
  验收检查:
    □ 所有P0功能测试通过
    □ 无阻塞性Bug
    □ 基础文档完整
    □ CI/CD流水线通过
  
  退出标准:
    - Alpha验收检查全部通过
    - 产品负责人签字确认
```

#### 5.5.2 Beta阶段验收

```yaml
Beta验收:
  准入条件:
    - Alpha验收通过
    - 所有P0/P1功能完成
    - 测试覆盖率≥85%
  
  验收检查:
    □ 集成测试全部通过
    □ 性能测试达标
    □ 文档完整度≥90%
    □ 安全扫描通过
    □ 跨平台测试通过 (macOS/Linux)
  
  退出标准:
    - Beta验收检查全部通过
    - 无P0/P1级别Bug
    - 用户验收测试(UAT)通过
```

#### 5.5.3 GA (正式发布) 验收

```yaml
GA验收:
  准入条件:
    - Beta验收通过
    - 运行2周无严重问题
  
  验收检查:
    □ 版本号正确 (语义化版本)
    □ Git Tag已打
    □ GitHub Release已创建
    □ PyPI包已发布
    □ Homebrew Formula已更新
    □ 文档站点已更新
    □ 变更日志已更新
    □ 升级指南已提供(如需要)
  
  退出标准:
    - GA验收检查全部通过
    - 发布通知已发送
```

#### 5.5.4 发布检查清单

```
┌─────────────────────────────────────────────────────────┐
│                    发布前最终检查单                       │
├─────────────────────────────────────────────────────────┤
│  代码质量                                                │
│  □ 所有CI检查通过 (lint/test/coverage)                  │
│  □ 代码审查完成 (至少1人approve)                         │
│  □ 无未解决的Code Review评论                            │
│                                                          │
│  测试验证                                                │
│  □ 单元测试通过率100%                                   │
│  □ 集成测试全部通过                                      │
│  □ 端到端测试通过                                        │
│  □ 手动回归测试完成                                      │
│                                                          │
│  文档检查                                                │
│  □ README最新且准确                                      │
│  □ API文档已生成并部署                                   │
│  □ 用户手册完整                                          │
│  □ 变更日志已更新                                        │
│                                                          │
│  发布制品                                                │
│  □ 版本号已更新 (pyproject.toml)                        │
│  □ Git Tag已创建 (vX.Y.Z)                               │
│  □ GitHub Release草稿已准备                              │
│  □ PyPI发布令牌有效                                      │
│  □ Homebrew Formula已测试                               │
│                                                          │
│  依赖检查                                                │
│  □ 所有依赖版本锁定                                      │
│  □ 安全扫描无漏洞                                        │
│  □ 许可证兼容检查通过                                    │
└─────────────────────────────────────────────────────────┘
```

### 5.6 运维监控验收标准

#### 5.6.1 日志规范验收

```yaml
日志格式验证:
  必含字段:
    □ timestamp: ISO8601格式 (2024-01-15T10:30:00Z)
    □ level: INFO/ERROR/WARNING/DEBUG
    □ file: 输入文件名 (不含路径)
    □ stage: preprocess/convert/cleanup
    □ duration_ms: 整数毫秒
    □ message: 人类可读描述
  
  错误日志必含:
    □ error.type: 错误类型分类
    □ error.message: 错误详情
    □ error.stack: 堆栈跟踪(开发模式)
  
  输出验证:
    □ JSON格式可解析
    □ 无敏感信息泄露
    □ 日志轮转配置正确
```

#### 5.6.2 性能监控指标

| 指标 | 基准值 | 告警阈值 | 验收标准 |
|------|--------|----------|----------|
| 单文件转换时间 | < 5s | > 10s | 95%请求达标 |
| 批量处理吞吐量 | > 2文件/秒 | < 1文件/秒 | 持续5分钟 |
| 内存使用峰值 | < 500MB | > 1GB | 单次转换 |
| CPU使用率 | < 80% | > 95% | 持续30秒 |
| 并发处理能力 | 支持8并发 | - | 同时8个任务 |

#### 5.6.3 错误率监控

| 错误类型 | 目标值 | 告警阈值 | 验收标准 |
|----------|--------|----------|----------|
| 转换失败率 | < 1% | > 5% | 24小时统计 |
| 依赖缺失错误 | 0 | > 0 | 即时 |
| 配置解析错误 | < 0.1% | > 1% | 24小时统计 |
| Mermaid渲染失败 | < 2% | > 10% | 24小时统计 |
| Pandoc调用失败 | < 0.5% | > 2% | 24小时统计 |

#### 5.6.4 健康检查

```yaml
健康检查端点:
  /health:
    检查项:
      □ pandoc可执行且版本符合
      □ tectonic可执行且版本符合
      □ mermaid-cli可执行且版本符合
      □ 临时目录可写
      □ 磁盘空间充足 (>1GB)
    
    响应格式:
      status: healthy/degraded/unhealthy
      version: 当前版本
      dependencies:
        pandoc: { version, status }
        tectonic: { version, status }
        mermaid: { version, status }
      checks:
        - name: disk_space
          status: pass/fail
          message: 描述信息
```

#### 5.6.5 可观测性验收

| 检查项 | 通过标准 |
|--------|----------|
| ✅ 结构化日志 | 所有日志为JSON格式，含必要字段 |
| ✅ 日志级别控制 | `--verbose` 和 `--quiet` 参数有效 |
| ✅ 性能指标暴露 | 转换耗时、成功率等指标可采集 |
| ✅ 错误追踪 | 错误有唯一ID，可关联追踪 |
| ✅ 诊断命令 | `md2pdf doctor` 提供完整诊断信息 |
| ✅ 调试模式 | `--debug` 输出详细调试信息 |

### 5.7 验收汇总表

#### 5.7.1 各阶段验收状态汇总

```
┌─────────────────┬──────────┬──────────┬──────────┬──────────┐
│    验收项       │  开发期  │  Alpha   │   Beta   │    GA    │
├─────────────────┼──────────┼──────────┼──────────┼──────────┤
│ 功能验收        │    -     │   必过   │   必过   │   必过   │
│ 单元测试        │   ≥70%   │   ≥80%   │   ≥85%   │   ≥85%   │
│ 集成测试        │    -     │   部分   │   必过   │   必过   │
│ 端到端测试      │    -     │    -     │   必过   │   必过   │
│ 代码质量门禁    │   警告   │   必过   │   必过   │   必过   │
│ 文档完整度      │   ≥50%   │   ≥70%   │   ≥90%   │  100%    │
│ 性能基准        │    -     │   参考   │   必过   │   必过   │
│ 安全扫描        │    -     │   必过   │   必过   │   必过   │
│ 用户验收        │    -     │    -     │   必过   │   必过   │
└─────────────────┴──────────┴──────────┴──────────┴──────────┘
```

#### 5.7.2 最终验收签字

| 角色 | 验收项 | 签字 | 日期 |
|------|--------|------|------|
| 产品经理 | 功能完整性 | ☐ | |
| 技术负责人 | 代码质量 | ☐ | |
| QA工程师 | 测试覆盖 | ☐ | |
| 文档工程师 | 文档完整 | ☐ | |
| DevOps | 部署就绪 | ☐ | |
| 安全工程师 | 安全合规 | ☐ | |

---

## 六、风险与缓解

### 6.1 风险矩阵

| 风险项 | 概率 | 影响 | 等级 | 缓解策略 |
|--------|------|------|------|----------|
| 系统依赖安装失败 | 中 | 高 | 🔴 | 准备Docker备用方案；编写详细安装脚本 |
| Mermaid渲染异常 | 中 | 高 | 🔴 | 预留调试时间；准备降级方案（PNG输出） |
| Pandoc/Tectonic兼容性问题 | 低 | 高 | 🟡 | 锁定版本号；提前测试关键功能 |
| 并发性能不达标 | 中 | 中 | 🟡 | 预留性能调优时间；准备串行降级方案 |
| 文件监控资源占用过高 | 低 | 中 | 🟢 | 实现智能防抖；限制监控范围 |

### 6.2 关键风险详细分析

#### 🔴 高风险 - 系统依赖安装

**风险描述**: Homebrew安装pandoc/tectonic/node可能因网络或权限问题失败

**影响**: 项目无法启动，开发阻塞

**预防措施：**
- 编写自动化安装脚本 `scripts/install-deps.sh`
- 准备Docker镜像作为备选方案
- 在README中提供详细的故障排除指南

**应急方案：**
```bash
# 如果Homebrew安装失败，使用Docker
docker run -v $(pwd):/workspace md2pdf-pro:latest
```

#### 🔴 高风险 - Mermaid渲染

**风险描述**: mmdc调用可能因Puppeteer/Chrome依赖问题失败

**影响**: Mermaid图表无法渲染，核心功能受损

**预防措施：**
- 预留2小时调试时间
- 测试多种Mermaid图表类型
- 准备PNG降级输出方案

**应急方案：**
```python
# 配置降级选项
MermaidConfig(
    output_format="pdf",  # 首选
    fallback_format="png"  # 降级方案
)
```

#### 🟡 中风险 - 并发性能

**风险描述**: 并发数设置不当可能导致资源耗尽或性能不佳

**影响**: 批量处理速度慢或系统不稳定

**预防措施：**
- 预留性能调优时间（阶段五）
- 实现可配置的并发数
- 准备串行处理降级方案

**监控指标：**
- 单文件转换时间 < 5秒
- 100文件批量转换 < 3分钟
- 内存占用 < 500MB

### 6.3 依赖关系和风险点

#### 6.3.1 外部依赖矩阵

| 依赖项 | 类型 | 版本约束 | 风险等级 | 缓解措施 |
|-------|------|---------|---------|---------|
| Pandoc | 核心 | >= 3.1.0 | 中 | 版本锁定+兼容性测试 |
| Tectonic | 核心 | >= 0.14.0 | 中 | 备选方案(原生LaTeX) |
| Mermaid-CLI | 核心 | >= 10.0.0 | 低 | 版本锁定 |
| Node.js | 间接 | 未指定 | 中 | 明确版本要求 |
| LaTeX发行版 | 间接 | 未指定 | 高 | 文档化依赖 |
| CJK字体 | 运行时 | 未指定 | 高 | 字体检测+安装指南 |

#### 6.3.2 关键风险点汇总

| 风险ID | 风险描述 | 影响 | 概率 | 缓解策略 |
|-------|---------|------|------|---------|
| R001 | CJK字体缺失导致中文渲染失败 | 功能不可用 | 高 | 预检测+自动安装+清晰错误提示 |
| R002 | LaTeX环境不完整导致编译失败 | 功能不可用 | 高 | 环境检查脚本+容器化方案 |
| R003 | Mermaid v9.2+功能在低版本不可用 | 思维导图失败 | 中 | 版本检测+功能降级 |
| R004 | 并发处理导致资源耗尽 | 系统不稳定 | 中 | 资源配额+熔断机制 |
| R005 | 网络图片下载超时阻塞 | 转换缓慢 | 中 | 异步下载+超时控制 |
| R006 | 大文件处理内存溢出 | 进程崩溃 | 中 | 流式处理+内存监控 |
| R007 | Pandoc版本兼容性问题 | 部分功能异常 | 低 | 兼容性测试矩阵 |
| R008 | Tectonic社区支持有限 | 问题难解决 | 低 | 文档完善+备选方案 |

---

## 七、交付物清单

### 7.1 代码交付物

| 文件路径 | 描述 | 所属阶段 |
|----------|------|----------|
| `src/md2pdf_pro/__init__.py` | 包初始化 | 1 |
| `src/md2pdf_pro/config.py` | 配置模块 | 1 |
| `src/md2pdf_pro/preprocessor.py` | Mermaid预处理器 | 2 |
| `src/md2pdf_pro/converter.py` | Pandoc转换器 | 2 |
| `src/md2pdf_pro/parallel.py` | 并行处理器 | 3 |
| `src/md2pdf_pro/cli.py` | CLI接口 | 4 |
| `src/md2pdf_pro/watcher.py` | 文件监控 | 5 |
| `src/md2pdf_pro/filters/mermaid.lua` | Lua过滤器 | 2 |

### 7.2 文档交付物

| 文件路径 | 描述 | 所属阶段 |
|----------|------|----------|
| `README.md` | 项目说明 | 6 |
| `docs/installation.md` | 安装指南 | 6 |
| `docs/usage.md` | 使用教程 | 6 |
| `docs/configuration.md` | 配置说明 | 6 |
| `docs/architecture.md` | 架构设计 | 6 |
| `examples/sample.md` | 示例文件 | 6 |

### 7.3 配置交付物

| 文件路径 | 描述 | 所属阶段 |
|----------|------|----------|
| `pyproject.toml` | 项目配置 | 1 |
| `requirements.txt` | Python依赖 | 1 |
| `.github/workflows/ci.yml` | CI配置 | 5 |
| `Makefile` | 构建脚本 | 1 |
| `config.yaml` | 默认配置 | 1 |

### 7.4 测试交付物

| 文件路径 | 描述 | 所属阶段 |
|----------|------|----------|
| `tests/test_config.py` | 配置模块测试 | 1 |
| `tests/test_preprocessor.py` | 预处理器测试 | 2 |
| `tests/test_converter.py` | 转换器测试 | 2 |
| `tests/test_parallel.py` | 并行处理器测试 | 3 |
| `tests/test_cli.py` | CLI测试 | 4 |
| `tests/test_integration.py` | 集成测试 | 3 |
| `tests/fixtures/` | 测试 fixtures | 3 |

---

## 八、附录

### 8.1 改进建议优先级

#### P0 - 立即处理（本周内）

| 序号 | 改进项 | 目标模块 | 工作量 | 预期收益 |
|-----|-------|---------|-------|---------|
| 1 | 补充并发控制详细规范 | parallel.py | 中 | 消除模糊点，确保稳定性 |
| 2 | 定义错误码体系和恢复机制 | 全局 | 中 | 提升容错能力 |
| 3 | 建立CJK字体检测和回退策略 | converter.py | 高 | 确保中文功能可用 |
| 4 | 明确LaTeX环境依赖清单 | 文档 | 低 | 降低部署风险 |
| 5 | 补充Mermaid版本兼容性矩阵 | preprocessor.py | 中 | 避免功能异常 |

#### P1 - 重要但不紧急（2周内）

| 序号 | 改进项 | 目标模块 | 工作量 | 预期收益 |
|-----|-------|---------|-------|---------|
| 6 | 设计配置管理系统规范 | config.py | 中 | 提升可配置性 |
| 7 | 建立日志和监控规范 | 全局 | 中 | 提升可观测性 |
| 8 | 定义性能基准和SLA指标 | 文档 | 低 | 明确质量目标 |
| 9 | 补充边界场景处理规范 | 全局 | 高 | 提升健壮性 |
| 10 | 设计模板继承机制 | templates/ | 中 | 提升模板复用 |

#### P2 - 优化建议（1个月内）

| 序号 | 改进项 | 目标模块 | 工作量 | 预期收益 |
|-----|-------|---------|-------|---------|
| 11 | 添加缓存机制设计 | preprocessor.py | 高 | 提升重复转换性能 |
| 12 | 设计插件系统接口 | 架构 | 高 | 提升扩展性 |
| 13 | 补充交互式CLI模式 | cli.py | 中 | 提升用户体验 |
| 14 | 添加进度反馈机制 | cli.py | 低 | 提升用户体验 |
| 15 | 设计容器化部署方案 | 运维 | 中 | 简化部署 |

### 8.2 依赖版本锁定

```
pandoc >= 3.1.0
tectonic >= 0.14.0
mermaid-cli >= 10.0.0
Python >= 3.11
Node.js >= 18.0.0
```

### 8.3 常见错误排查

| 错误 | 原因 | 解决 |
|-----|------|------|
| `mmdc: command not found` | Node模块未全局安装 | `npm install -g @mermaid-js/mermaid-cli` |
| `font-not-found` | LaTeX缺少中文字体 | 安装`xeCJK`宏包或指定系统字体 |
| `timeout` | 单文件过大 | 增加`processing.timeout`配置 |
| `pandoc: command not found` | Pandoc未安装 | `brew install pandoc` |
| `tectonic: command not found` | Tectonic未安装 | `brew install tectonic` |

### 8.4 参考资源

- [Pandoc Manual](https://pandoc.org/MANUAL.html)
- [Mermaid Diagrams](https://mermaid.js.org/)
- [Tectonic Typesetting](https://tectonic-typesetting.github.io/)
- [Python测试最佳实践](https://docs.python-guide.org/writing/tests/)
- [语义化版本规范](https://semver.org/lang/zh-CN/)
- [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)

### 8.5 术语定义

- **P0**: 阻塞性问题，必须解决
- **P1**: 重要问题，应该解决
- **P2**: 次要问题，可以延后
- **GA**: General Availability，正式发布
- **UAT**: User Acceptance Testing，用户验收测试
- **SPEC**: Specification-Execution-Performance-Completion 方法论

---

## 总结

| 指标 | 数值 |
|------|------|
| 总工时 | 72小时（9个工作日） |
| 关键路径 | 52小时 |
| 阶段数 | 6个 |
| 任务数 | 24个主任务 / 68个子任务 |
| 里程碑数 | 5个 |
| 风险项 | 5个（2个高风险） |

### 关键成功因素

1. **严格按照关键路径执行**，确保前4个阶段按时完成
2. **预留1天缓冲时间**应对突发情况
3. **优先处理P0级改进建议**，消除高风险项
4. **每日进行进度同步**，及时发现阻塞点
5. **保持与SPEC文档的同步更新**，确保规范与实现一致

---

*文档版本: 1.0.0*  
*最后更新: 2026-02-28*  
*基于SPEC方法论制定*
