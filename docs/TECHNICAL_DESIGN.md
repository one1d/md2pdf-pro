# MD2PDF Pro - 完整技术设计文档

> 版本: 1.0.0  
> 日期: 2026-02-28  
> 状态: 待开发

---

## 一、项目架构总览

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           MD2PDF Pro 系统架构                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                   │
│  │   CLI层     │    │   API层     │    │   核心引擎   │                   │
│  │  (Typer)    │◄──►│  (Python)   │◄──►│  (asyncio)  │                   │
│  └─────────────┘    └─────────────┘    └─────────────┘                   │
│         │                                       │                           │
│         ▼                                       ▼                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         配置管理 (Pydantic)                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│         ┌──────────────────────────┼──────────────────────────┐          │
│         ▼                          ▼                          ▼          │
│  ┌─────────────┐          ┌─────────────┐          ┌─────────────┐      │
│  │   输入层    │          │   处理层     │          │   输出层    │      │
│  │             │          │              │          │             │      │
│  │ - 文件扫描  │────────►│ - Mermaid   │────────►│ - PDF生成   │      │
│  │ - YAML解析  │          │ - 图片处理   │          │ - 元数据    │      │
│  │ - 元数据    │          │ - 链接检查   │          │ - 优化      │      │
│  └─────────────┘          └─────────────┘          └─────────────┘      │
│                                    │                                        │
│                                    ▼                                        │
│                        ┌─────────────────────┐                             │
│                        │    并行处理引擎      │                             │
│                        └─────────────────────┘                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 模块依赖关系

```
cli.py (入口)
    │
    ├── config.py (配置管理)
    ├── converter.py (Pandoc引擎)
    ├── preprocessor.py (预处理)
    ├── parallel.py (并行处理)
    └── watcher.py (文件监控)
```

---

## 二、模块详细设计

### 2.1 配置模块 (config.py)

#### 2.1.1 配置模型层次

```python
ProjectConfig (根配置)
    ├── MermaidConfig (Mermaid渲染配置)
    ├── PandocConfig (Pandoc转换配置)
    ├── ProcessingConfig (处理配置)
    ├── FontConfig (字体配置)
    ├── OutputConfig (输出配置)
    └── LoggingConfig (日志配置)
```

#### 2.1.2 配置加载优先级

```
CLI参数 > 环境变量 > 配置文件 (~/.md2pdf/config.yaml) > 默认值
```

---

### 2.2 Mermaid预处理器 (preprocessor.py)

#### 2.2.1 处理流程

```
输入Markdown → 代码块解析 → Hash计算 → 缓存检查 → 调用mmdc或返回缓存 → 替换为图片引用 → 输出
```

#### 2.2.2 错误处理策略

| 错误类型 | 处理策略 |
|---------|---------|
| Mermaid语法错误 | 输出警告，继续转换 |
| mmdc未找到 | 抛出异常，建议安装 |
| 渲染超时 | 重试1次，失败则跳过 |

---

### 2.3 Pandoc转换器 (converter.py)

#### 2.3.1 核心功能

- 异步调用Pandoc
- 参数动态构建
- 超时控制
- 错误捕获与报告

---

### 2.4 并行处理模块 (parallel.py)

#### 2.4.1 并发控制

- Semaphore信号量控制并发数
- Rich进度条显示
- 错误隔离与汇总

---

### 2.5 CLI模块 (cli.py)

#### 2.5.1 命令结构

```
md2pdf
├── convert    单文件转换
├── batch      批量转换
├── watch      监听模式
├── config     配置管理
├── doctor     环境检查
└── --version  显示版本
```

---

### 2.6 文件监控模块 (watcher.py)

#### 2.6.1 功能

- Watchdog文件监控
- 防抖处理
- 自动触发转换

---

## 三、数据流设计

### 3.1 完整转换流程

```
Stage 1: 输入处理
  → 读取文件、解析YAML Front Matter

Stage 2: 预处理
  → Mermaid渲染、图片下载、链接验证

Stage 3: 转换
  → 构建Pandoc参数、执行转换、验证输出

Stage 4: 输出
  → 复制到目标目录、PDF优化、清理临时文件
```

---

## 四、错误处理设计

### 4.1 错误分类

| 错误码 | 说明 |
|-------|------|
| 1 | 参数错误 |
| 2 | 依赖缺失 |
| 3 | 转换失败 |
| 4 | 处理超时 |
| 5 | 文件不存在 |
| 6 | 权限错误 |
| 7 | 配置错误 |
| 8 | 内存不足 |

---

## 五、缓存设计

### 5.1 缓存目录结构

```
~/.cache/md2pdf/
├── mermaid/     # Mermaid图表缓存
├── images/      # 图片缓存
└── templates/   # 模板缓存
```

---

## 六、性能目标

| 指标 | 目标值 |
|-----|-------|
| 100文件批量转换 | < 120秒 |
| 单文件峰值内存 | < 500MB |
| 平均CPU利用率 | > 75% |
| 转换成功率 | > 98% |
| 缓存命中率 | > 85% |

---

## 七、测试策略

### 7.1 测试覆盖率目标

| 模块 | 行覆盖率 |
|------|---------|
| config.py | ≥90% |
| preprocessor.py | ≥85% |
| converter.py | ≥85% |
| parallel.py | ≥80% |
| watcher.py | ≥75% |
| cli.py | ≥80% |
| **总计** | **≥85%** |

---

## 八、CI/CD设计

### 8.1 GitHub Actions

- 自动化测试
- Lint检查 (ruff, mypy, black)
- 覆盖率报告
- 自动发布到PyPI

---

## 九、发布计划

### 9.1 版本规范

```
MAJOR.MINOR.PATCH[-prerelease]
```

### 9.2 发布流程

1. 预发布检查
2. 版本标签
3. 构建发布
4. 通知
